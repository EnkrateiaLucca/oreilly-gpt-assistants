# app.py - Slack Bot for OpenAI Assistants

This file implements a Slack bot that integrates with OpenAI's Assistants API to provide intelligent responses to user messages.

## Overview

The application creates a Slack bot that:
- Listens to all messages in channels where it's present
- Processes user queries through an OpenAI Assistant
- Responds with text and can upload generated files (like images)
- Handles both text responses and file uploads

## Dependencies

```python
import os
from slack_bolt import App
from slack_bolt.adapter.socket_mode import SocketModeHandler
from dotenv import load_dotenv
import threading

# Import the function from assistants.py
from assistants import process_thread_with_assistant
```

## Configuration

```python
load_dotenv()

app = App(token=os.environ.get("SLACK_BOT_TOKEN_ASSISTANTS"))
```

## Message Handler

The main message handler processes all messages sent to the bot:

```python
@app.message("")
def message_handler(message, say, ack):
    ack()  # Acknowledge the event immediately
    user_query = message['text']
    # assistant_id = "asst_qPkFH6kDCiYuCXZgW259VyDb"
    assistant_id = ""
    from_user = message['user']

    def process_and_respond():
        response = process_thread_with_assistant(user_query, assistant_id, from_user=from_user)
        if response:
            # Check if there are any in-memory files to upload
            if response.get("in_memory_files"):
                for i, in_memory_file in enumerate(response["in_memory_files"]):
                    print(in_memory_file)
                    # Use the corresponding text as the annotation for the file
                    annotation_text = response["text"][i] if i < len(response["text"]) else "Here's the file you requested:"
                    # Get upload URL from Slack
                    upload_response = app.client.files_upload_v2(
                        channel=message['channel'],
                        filename="image.png",  # or dynamically set the filename
                        file=in_memory_file,
                        initial_comment=annotation_text,  # Text response as annotation
                        title="Uploaded Image"
                    )
            else:
                # If no files to upload, send text responses normally
                for text in response.get("text", []):
                    say(text, thread_ts=message['ts'])
        else:
            say("Sorry, I couldn't process your request.", thread_ts=message['ts'])

    threading.Thread(target=process_and_respond).start()
```

## Key Features

### 1. **Message Processing**
- Acknowledges messages immediately to avoid timeouts
- Extracts user query and user ID from the message
- Processes the query through the OpenAI Assistant

### 2. **File Handling**
- Checks for in-memory files generated by the assistant
- Uploads files to Slack with appropriate annotations
- Handles both text responses and file uploads

### 3. **Threading**
- Uses threading to handle potentially long-running assistant operations
- Prevents blocking the main Slack event loop

### 4. **Error Handling**
- Provides fallback responses when processing fails
- Handles missing responses gracefully

## Configuration Variables

- `SLACK_BOT_TOKEN_ASSISTANTS`: Slack bot token for authentication
- `SLACK_APP_TOKEN_ASSISTANTS`: Slack app token for socket mode
- `assistant_id`: OpenAI Assistant ID (currently empty - needs to be set)

## Usage

1. Set up environment variables in `.env`:
   ```
   SLACK_BOT_TOKEN_ASSISTANTS=your_slack_bot_token
   SLACK_APP_TOKEN_ASSISTANTS=your_slack_app_token
   ```

2. Configure the `assistant_id` variable with your OpenAI Assistant ID

3. Run the application:
   ```python
   if __name__ == "__main__":
       SocketModeHandler(app, os.environ.get("SLACK_APP_TOKEN_ASSISTANTS")).start()
   ```

## Integration Points

- **assistants.py**: Contains the `process_thread_with_assistant` function
- **OpenAI Assistants API**: Processes user queries and generates responses
- **Slack API**: Handles message events and file uploads

## Response Flow

1. User sends message in Slack
2. Bot acknowledges the message
3. Query is processed by OpenAI Assistant
4. Response is parsed for text and files
5. Files are uploaded to Slack if present
6. Text responses are sent as threaded replies

This implementation provides a robust foundation for building intelligent Slack bots powered by OpenAI's Assistants API.